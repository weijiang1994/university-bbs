{% extends "frontend/base.html" %}
{% from "macro.html" import reportModal, markdownHelp, confirmDelete, render_pagination, commentDiv, editComment with context %}
{% block head %}
    {{ super() }}
    {{ ckeditor.load_code_theme() }}
    {% if request.cookies.get('bbs_themes', 'darkly') in ['darkly', 'cyborg', 'slate', 'superhero', 'solar'] %}
        <link href="{{ url_for('static', filename='css/code.css') }}" rel="stylesheet">
    {% else %}
        <link href="{{ url_for('static', filename='css/code-light.css') }}" rel="stylesheet">
    {% endif %}
    <!--suppress ALL -->
    <style>
        #previewHtml {
            height: 210px;
            overflow-y: scroll;
            padding-right: 10px;
        }


        .small-pic {
            height: 30%;
            width: 30%;
        }

        .post-title-h1 {
            font-size: 22px;
            font-weight: bold;
        }

        article > h1 {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0 10px 0;
            padding: 0 10px;
            border-left: 5px solid #20c997;
            line-height: 2em;
        }

        article > h2 {
            font-size: 18px;
            margin-top: 5px;
            margin-bottom: 5px;
            padding: 5px 5px 5px 5px;
            border-bottom: 1px solid #28a745;
        }

        article > h3 {
            font-size: 18px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 5px 5px 5px 5px;
            border-bottom: 1px solid #28a745;
        }

        blockquote > p {
            font: 14px/22px normal helvetica, sans-serif;
            margin: 5px 0px 5px 0px;
            font-style: italic;
        }

        .report-textarea {
            height: 100px !important;
        }

        .preview {
            background: white;
            border-radius: 5px;
            color: black !important;
        }

        .blockquote-comment {
            margin-top: 5px;
            border-left: 6px solid #6c6c6c;
            background: #6c757d;
            color: white;
            padding: 8px;
        }

        .p-error-hint {
            color: #f94b43;
            display: none;
            font-weight: bold;
        }

        .p-info-hint {
            color: #0b75c9;
            display: none;
            font-weight: bold;
        }

        .p-reply {
            color: #80bdff;
            margin-bottom: 0px;
        }

        .div-comment-body {
            padding-bottom: 6px;
        }

        .div-gutter20 {
            height: 20px;
        }

        @media screen and (max-width: 567px) {
            .div-gutter20 {
                height: 5px;
            }
        }

        .hr-margin-5 {
            margin: 5px 0 5px 0 !important;
        }

        .op-badge {
            background-color: #336699;
            border-radius: 5px;
            padding: 3px;
            color: white;
            font-size: 75%;
        }

        .post-audit {
            border: solid 1px #ffb243;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin-left: 4px;
        }
    </style>
{% endblock %}
{% block title %}
    {{ post.title }}
{% endblock %}

{% block content %}
    {{ moment.locale(auto_detect=True) }}
    <body>
    <main>
        <div class="container mt-2">
            {% include "_flash.html" %}
            {% include "frontend/big-image.html" %}
            <!-- 帖子主要信息 -->
            <ol class="breadcrumb mb-0 rounded-0">
                <li class="breadcrumb-item"><a class="text-decoration-none" href="/">主页</a></li>
                <li class="breadcrumb-item"><a class="text-decoration-none"
                                               href="{{ url_for('post.post_cate', cate_id=post.cats.id) }}">{{ post.cats.name }}</a>
                </li>
                <li class="breadcrumb-item active d-lg-block d-none">{{ post.title }}</li>
            </ol>

            <div class="post-div rounded-0">
                <div class="d-flex">
                    <h1 class="post-title-h1" id="postTitle" data-id="{{ post.id }}">{{ post.title }}</h1>
                    {% if post.status.name == '未审核' and current_user.is_authenticated and current_user.id == post.user.id %}
                        <p class="mb-0"><span class="post-audit border-warning text-warning ">审核中</span></p>
                    {% endif %}
                </div>
                <div class="d-flex mb-0">
                    <p class="text-muted mr-2 mb-0"><i class="fa fa-thumbs-o-up mr-1"></i><span
                            class="d-none d-lg-inline-block">点亮</span>({{ post.likes }}) </p>
                    <p class="text-muted mr-2 mb-0"><i class="fa fa-thumbs-o-down mr-1"></i><span
                            class="d-none d-lg-inline-block">点灭</span>({{ -post.unlikes }}) </p>
                    <p class="text-muted mr-2 mb-0"><i class="fa fa-heart mr-1"></i><span
                            class="d-none d-lg-inline-block">收藏</span>({{ post.collects }}) </p>
                    <p class="text-muted mb-0"><i class="fa fa-calendar-minus-o mr-1"></i>{{ post.create_time }}</p>
                    {% if post.is_elite %}
                        <span class="elite-star ml-2" title="精品帖子"><i class="fa fa-star"></i></span>
                    {% endif %}
                </div>

                <div class="d-flex">
                    {% if post.is_anonymous == 1 %}
                        <img src="{{ post.user.avatar }}" class="rounded avatar-50">
                        <div class="d-flex">
                            <div>
                                <a class="ml-2 text-decoration-none"
                                   href="{{ url_for('profile.index', user_id=post.user.id) }}">{{ post.user.nickname }}</a>
                                <div class="d-flex">
                                    <a class="text-decoration-none ml-2"><span
                                            class="badge badge-pill badge-success">{{ post.user.college.name }}</span></a>
                                    <a class="text-decoration-none ml-2"><span
                                            class="badge badge-pill badge-info">{{ post.user.role.name }}</span></a>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <img src="{{ url_for('static', filename='img/anonymous.jpeg') }}" class="rounded avatar-50">
                        <div class="d-flex">
                            <div>
                                <a class="ml-2 text-muted text-decoration-none">匿名</a>
                                <div class="d-flex">
                                    <a class="text-decoration-none ml-2"><span
                                            class="badge badge-pill badge-success">{{ post.user.college.name }}</span></a>
                                    <a class="text-decoration-none ml-2"><span
                                            class="badge badge-pill badge-info">{{ post.user.role.name }}</span></a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="mt-2">
                    <article>
                        {{ post.content|safe }}
                    </article>
                    {% for tag in p_tags %}
                        <label class="post-tag"><a style="color: inherit" class="text-decoration-none"
                                                   href="{{ url_for('post.post_tag', tag_id=tag.tag.id) }}">#{{ tag.tag.name }}</a></label>
                    {% endfor %}
                </div>
                {% if current_user.is_authenticated and current_user.id == post.user.id %}
                    <div class="d-flex flex-row-reverse mt-1">
                        <a class="text-decoration-none text-muted"
                           href="/post/edit/{{ post.id }}/"><small>编辑</small></a>
                        <a class="mr-2 text-decoration-none text-muted"
                           href="/post/delete/{{ post.id }}/"><small>删除</small></a>
                    </div>
                {% elif current_user.is_authenticated %}
                    <div class="d-flex flex-row-reverse mt-1">
                        <a class="text-decoration-none text-muted ml-2" data-toggle="modal" data-target="#exampleModal"
                           href="#"><small>举报</small></a>
                        <a class="text-decoration-none text-muted ml-2" href="/post/collect/{{ post.id }}/">
                            <small>
                                {% if c_tag %}
                                    取消收藏
                                {% else %}
                                    收藏
                                {% endif %}
                            </small>
                        </a>
                        {% if post.user_unliked() %}
                            <a class="text-decoration-none text-muted ml-2"
                               href="/post/unlike/{{ post.id }}/"><small>取消点灭</small></a>
                        {% elif post.user_liked() %}
                            <a class="text-decoration-none text-muted ml-2"
                               href="/post/like/{{ post.id }}/"><small>取消点亮</small></a>
                        {% else %}
                            <a class="text-decoration-none text-muted ml-2"
                               href="/post/unlike/{{ post.id }}/"><small>点灭</small></a>
                            <a class="text-decoration-none text-muted ml-2"
                               href="/post/like/{{ post.id }}/"><small>点亮</small></a>
                        {% endif %}
                        {% if current_user.role_id == 1 %}
                            {% if post.is_elite %}
                                <a class="text-decoration-none text-muted ml-2"
                                   href="{{ url_for('post.elite', post_id=post.id) }}"><small>取消精品贴</small></a>
                            {% else %}
                                <a class="text-decoration-none text-muted ml-2"
                                   href="{{ url_for('post.elite', post_id=post.id) }}"><small>精品贴</small></a>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="div-gutter20"></div>

            <!-- 评论主要信息 -->
            {% if comments %}
                <div class="post-div">
                    <div class=" mt-2">
                        <div class="d-flex div-comment-body">
                            {{ pagination.total }}条回复 &nbsp;&nbsp; · &nbsp;&nbsp;{{ post.update_time }}
                        </div>
                        {% for comment in comments %}
                            <div class="div-comment-body mt-2">
                                <!-- 评论用户个人信息 -->
                                <div class="d-flex">
                                    <div class="d-flex">
                                        {% if post.is_anonymous == 1 %}
                                            {{ commentDiv(comment, post) }}
                                        {% else %}
                                            {% if post.author_id == comment.author_id %}
                                                {{ commentDiv(comment, post, anonymous=True) }}
                                            {% else %}
                                                {{ commentDiv(comment, post) }}
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- 用户评论内容 -->
                                <div class="mt-1 comment-content" id="comContent{{ comment.id }}">
                                    <div>
                                        {% if comment.replied_id %}
                                            <div class="post-content">
                                                {% if not comment.replied.delete_flag %}
                                                    {% if post.is_anonymous != 1 and post.author_id == comment.replied.author_id %}
                                                        <p class="mb-1 ">引用<span
                                                                class="p-reply text-decoration-none">@Anonymous</span>回复
                                                        </p>
                                                    {% else %}
                                                        <p class="mb-1 ">引用<a
                                                                href="/profile/user/{{ comment.replied.author.id }}/"
                                                                class="p-reply text-decoration-none">@{{ comment.replied.author.nickname }}</a>回复
                                                        </p>
                                                    {% endif %}
                                                    {{ comment.replied.body|safe }}
                                                {% else %}
                                                    <p class="mb-1 ">引用<a
                                                            href="/profile/user/{{ comment.replied.author.id }}/"
                                                            class="p-reply text-decoration-none">@{{ comment.replied.author.nickname }}</a>回复
                                                    </p>
                                                    <p class="text-muted mt-0"><b>由于作者删除或该评论违规已被隐藏</b></p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        {{ comment.body|safe }}
                                    </div>
                                </div>
                                <!-- 对于该评论的操作 -->
                            </div>
                            <div class="comContent{{ comment.id }}"></div>
                            <div class="d-flex flex-row-reverse mt-1 border-bottom border-dark">
                                {% if current_user.is_authenticated %}
                                    {% if current_user.id == comment.author.id %}
                                        <a class="text-decoration-none text-muted ml-2" href="#"
                                           data-commid="{{ comment.id }}" data-toggle="modal"
                                           data-target="#confirm-delete">
                                            <small>删除</small>
                                        </a>
                                        {% if comment.md %}
                                            <a class="text-decoration-none text-muted ml-2" href="#"
                                               data-commid="{{ comment.id }}" data-toggle="modal"
                                               data-target="#edit-comment">
                                                <small>编辑</small>
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <a class="text-decoration-none text-muted ml-2" data-toggle="modal"
                                           data-target="#exampleModal" href="#"><small>举报</small></a>
                                        <a class="text-decoration-none text-muted ml-2 span-hand"
                                           data-commid="{{ comment.id }}"
                                                {% if post.is_anonymous != 1 and comment.author_id== post.author_id %}
                                           onclick="reply($(this).data('commid'), 'Anonymous', $(this).data('userid'))"
                                                {% else %}
                                           onclick="reply($(this).data('commid'), $(this).data('user'), $(this).data('userid'))"
                                                {% endif %}
                                           data-userid="{{ comment.author.id }}"
                                           data-user="{{ comment.author.username }}"><small>回复</small></a>
                                    {% endif %}
                                {% endif %}
                                <a class="text-decoration-none ml-2 text-muted flex-grow-1 text-left">
                                        <span data-toggle="tooltip" data-placement="right"
                                              data-timestamp="{{ comment.timestamps }}" data-delay="500"
                                              data-original-title=""
                                              title="{{ comment.timestamps }}"><small>{{ moment(comment.timestamps, local=True).fromNow(refresh=True) }}</small></span>
                                </a>
                                <a class="text-decoration-none ml-2 text-muted text-left"
                                   href="#"><small><span>#{{ loop.index + (page-1)*per_page }}</span></small></a>
                            </div>
                        {% endfor %}
                        {% if pagination.pages > 1 %}
                            <div class="d-flex flex-row-reverse mt-2">
                                {{ render_pagination(pagination=pagination, size='sm') }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="div-gutter20"></div>
            {% endif %}

            <!-- 评论框 -->
            <div class="post-div post-comment">
                <p id="commentPosition"></p>
                {% if current_user.is_authenticated %}
                    <div>
                        <ul class="nav nav-pills " role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="pill" href="#addComment"><i
                                        class="fa fa-commenting mr-2"></i>评论</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" onclick="getMarkDownData('commentContent', 'previewHtml')"
                                   data-toggle="pill"
                                   href="#previewComment"><i class="fa fa-print mr-2"></i>预览</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div id="addComment" class="tab-pane active">
                                <textarea onkeydown="tab(this)" class="form-control mt-2 report-textarea"
                                          style="height: 150px!important;" id="commentContent"
                                          placeholder="请输入评论内容"></textarea>
                                <!-- 快捷工具栏 -->
                                <div class="d-flex mt-1">
                                    <a class="mb-1 text-decoration-none a-link mr-2" href="#" id="commentEmoji"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa fa-smile-o fa-fw" data-toggle="tooltip" title="插入表情"></i>
                                    </a>
                                    <div class="dropdown-menu" id="emoji-list" aria-labelledby="commentEmoji">
                                        {% for emoji_url in emoji_urls %}
                                            <div style="padding:3px">
                                                {% for emoji in emoji_url %}
                                                    <button class="btn p-1">
                                                        <img class="img-emoji"
                                                             src="{{ url_for('static', filename='emojis/'+emoji[0]) }}"
                                                             data-toggle="tooltip" data-placement="right"
                                                             title="{{ emoji.1 }}" alt="{{ emoji.1 }}"
                                                             data-emoji=":{{ emoji.1 }}:">
                                                    </button>
                                                {% endfor %}
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <a onclick="upload()" class="mb-1 text-decoration-none a-link span-hand mr-2">
                                        <i class="fa fa-photo  fa-fw" title="插入图片" data-toggle="tooltip"></i>
                                    </a>
                                    <input type="file" id="uploadInput" onchange="uploadImage()" accept=".png"
                                           hidden="hidden">

                                    <div class="dropdown mr-2">
                                        <a id="dropdownMenuLink" data-toggle="dropdown" aria-expanded="false">
                                            <i class="fa fa-header fa-fw" data-toggle="tooltip" title="插入标题"></i>
                                        </a>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                            <a class="dropdown-item" onclick="insertMarkdown('h1')">H1</a>
                                            <a class="dropdown-item" onclick="insertMarkdown('h2')">H2</a>
                                            <a class="dropdown-item" onclick="insertMarkdown('h3')">H3</a>
                                        </div>
                                    </div>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('bold')">
                                        <i class="fa fa-bold  fa-fw" title="粗体" data-toggle="tooltip"></i>
                                    </a>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('italic')">
                                        <i class="fa fa-italic fa-fw" title="斜体" data-toggle="tooltip"></i>
                                    </a>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('list')">
                                        <i class="fa fa-list-ul fa-fw" title="列表" data-toggle="tooltip"></i>
                                    </a>

                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('code')">
                                        <i class="fa fa-code fa-fw" title="插入代码" data-toggle="tooltip"></i>
                                    </a>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('table')">
                                        <i class="fa fa-table fa-fw" title="插入表格" data-toggle="tooltip"></i>
                                    </a>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2"
                                       onclick="insertMarkdown('link')">
                                        <i class="fa fa-link fa-fw" title="插入链接" data-toggle="tooltip"></i>
                                    </a>
                                    <a onclick="insertMarkdown('image')"
                                       class="mb-1 text-decoration-none a-link span-hand mr-2">
                                        <i class="fa fa-cloud fa-fw" title="插入远程图片" data-toggle="tooltip"></i>
                                    </a>
                                    <a class="mb-1 text-decoration-none a-link span-hand mr-2" data-toggle="modal"
                                       data-target="#markdownHelp"><i class="fa fa-info-circle  fa-fw" title="查看帮助信息"
                                                                      data-toggle="tooltip"></i>
                                    </a>
                                    <p class="flex-grow-1 text-right mb-1 p-error-hint">请输入评论内容!</p>
                                    <p class="flex-grow-1 text-right mb-1 p-info-hint" id="upload-img-hint">正在上传图片<i
                                            class="fa fa-spinner fa-spin"></i></p>
                                </div>
                                <div class="d-flex flex-row-reverse">
                                    <button class="btn btn-info" id="commentBtn" onclick="postComment()">评论</button>
                                    <button hidden="hidden" id="replyBtn" onclick="replyComment()"
                                            class="btn btn-success mt-2">回复
                                    </button>
                                    <button hidden="hidden" id="cancelReplyBtn" onclick="cancelReply()"
                                            class="btn btn-danger mt-2 mr-2">取消
                                    </button>
                                    <a id="replyUserP" hidden="hidden"
                                       class="p-reply flex-grow-1 text-decoration-none"></a>
                                </div>
                            </div>
                            <!-- 评论预览界面 -->
                            <div id="previewComment" class="tab-pane fade">
                                <div id="previewHtml" class="mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center">
                        <div class="card-body text-center m-2 m-md-3 f-16" id="no-editor">
                            <div>您尚未登录，
                                <a href="/auth/login/"><span class="badge badge-info">登录</span></a> 或
                                <a href="/auth/register/"><span class="badge badge-success">注册</span></a> 后评论
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- 举报内容填写模态框 -->
        {{ reportModal() }}
        {{ markdownHelp() }}
        {{ confirmDelete() }}
        {{ editComment() }}
        <script>
            let editCommentId = null
            $(document).ready(function () {

            })
            window.onload = function () {
                let ccs = document.getElementsByClassName('comment-content')
                let height = $(".comment-content").css('max-height')
                if (!height){
                    return false
                }
                height = parseInt(height.split('px')[0])
                for (let i = 0; i < ccs.length; i++) {
                    if (ccs[i].children[0].scrollHeight > height) {
                        let contentId = ccs[i].id
                        let collapse = $('.' + contentId)
                        collapse.append(`<a class="span-hand text-decoration-none" onclick="collapseComment('${contentId}')">展开</a>`)
                    }
                }
            }

            function collapseComment(contentId) {
                let status = $(`.${contentId}`).children('a').text()
                switch (status) {
                    case "展开":
                        $(`#${contentId}`).removeClass('comment-content')
                        $(`.${contentId}`).children('a').text('折叠')
                        break
                    case "折叠":
                        $(`#${contentId}`).addClass('comment-content')
                        $(`.${contentId}`).children('a').text('展开')
                        break
                }
            }

            function insertMarkdown(type) {
                let obj = document.getElementById('commentContent')
                switch (type) {
                    case "image":
                        insertText(obj, '![alt 属性文本](图片地址)')
                        break
                    case 'link':
                        insertText(obj, '[链接名称](链接地址)')
                        break
                    case 'bold':
                        insertText(obj, '**文本**')
                        break
                    case 'italic':
                        insertText(obj, '*文本*')
                        break
                    case 'h1':
                        insertText(obj, '# ')
                        break
                    case 'h2':
                        insertText(obj, '## ')
                        break
                    case 'h3':
                        insertText(obj, '### ')
                        break
                    case 'code':
                        insertText(obj, '```\ncode\n```')
                        break
                    case 'table':
                        insertText(obj, '|  表头   | 表头  |\n |  ----  | ----  |\n | 单元格  | 单元格 |\n | 单元格  | 单元格 |\n')
                        break
                    case 'list':
                        insertText(obj, '- ')
                        break
                }
            }

            document.getElementById('commentContent').addEventListener('paste', function (e) {
                if (!(e.clipboardData && e.clipboardData.items)) {
                    return;
                }
                for (let i = 0, len = e.clipboardData.items.length; i < len; i++) {
                    let item = e.clipboardData.items[i];
                    if (item.kind === "file") {
                        let blob = item.getAsFile();
                        if (blob.size === 0) {
                            return;
                        }
                        let formdata = new FormData();
                        formdata.append("file", blob);
                        uploadimg2server(formdata)
                    }
                }
            });

            function uploadimg2server(formdata) {
                let infoHint = $("#upload-img-hint")
                infoHint.html('正在上传图片<i class="fa fa-spinner fa-spin"><i>')
                infoHint.slideDown(100);
                $.ajax({
                    url: "/normal/ajax-upload/",
                    type: "post",
                    async: false,
                    data: formdata,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        insertText(document.getElementById('commentContent'), res.imgPath)
                        infoHint.show().hide(500);
                    },
                    error: function () {
                        infoHint.text('图片上传失败！')
                        infoHint.show().delay(2000).hide(500);
                    }
                })
            }

            // 刷新页面清除保存在sessionStorage中的原始数据
            $(function () {
                sessionStorage.setItem('md', '');
            })

            function cancelReply() {
                $("#commentBtn").removeAttr('hidden');
                $("#replyBtn").attr('hidden', 'hidden');
                $("#cancelReplyBtn").attr('hidden', 'hidden');
                $("#replyUserP").html('');
                $("#replyUserP").attr('hidden', 'hidden');
            }

            function replyComment() {
                let comment = isEmpty();
                if (!comment) {
                    return false;
                }
                let replyBtn = $("#replyBtn")
                let cancelBtn = $("#cancelReplyBtn")
                replyBtn.attr('disabled', 'disabled')
                replyBtn.html('回复<i class="fa fa-pulse fa-spinner"></i>')
                cancelBtn.attr('disabled', 'disabled')
                let commentId = sessionStorage.getItem('commentId');
                let commentUserId = sessionStorage.getItem('commentUserId');
                let postId = $("#postTitle").data('id');
                $.ajax({
                    type: "post",
                    url: "/post/reply-comment/",
                    data: {
                        "post_id": postId,
                        "comment_id": commentId,
                        "comment_user_id": commentUserId,
                        "comment": comment
                    },
                    success: function (res) {
                        if (res.tag === 1) {
                            window.location.reload();
                        } else {
                            replyBtn.removeAttr('disabled')
                            replyBtn.html('评论')
                            cancelBtn.removeAttr('disabled', 'disabled')
                        }
                    },
                    error: function () {
                        replyBtn.removeAttr('disabled')
                        replyBtn.html('回复')
                        cancelBtn.re('disabled')
                        alert('服务器发生错误，回复失败！')
                    }
                })
            }

            function reply(commentId, commentUser, commentUserId) {
                $("#commentBtn").attr('hidden', 'hidden');
                $("#replyBtn").removeAttr('hidden');
                $("#cancelReplyBtn").removeAttr('hidden');
                $("#replyUserP").removeAttr('hidden');
                $("#replyUserP").html('@' + commentUser);
                if (commentUser !== 'Anonymous') {
                    $("#replyUserP").attr('href', '/profile/user/' + commentUserId + '/');
                }
                sessionStorage.setItem('commentId', commentId);
                sessionStorage.setItem('commentUserId', commentUserId);
                $('html,body').animate({scrollTop: $("#commentPosition").offset().top - 100}, 200)
            }

            var emoji_tag = $("#emoji-list img");
            emoji_tag.click(function () {
                var e = $(this).data('emoji');
                $("#commentContent").val($("#commentContent").val() + e);
            });

            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })

            // 预览评论
            function getMarkDownData(contentId, previewId) {
                let comment = $(`#${contentId}`).val();
                if (comment == '') {
                    $(`#${previewId}`).html('<p class="text-muted"><b>你还没有输入评论!</b></p>')
                    return false;
                }
                let last = sessionStorage.getItem('md');
                // 评论没有修改时,不发送预览请求
                if (last && last === comment) {
                    return false;
                }
                sessionStorage.setItem('md', comment);
                $.ajax({
                    type: "post",
                    url: '/normal/comment/render-md/',
                    data: {'md': comment},
                    success: function (res) {
                        $(`#${previewId}`).html(res.html);
                    }
                })
            }

            function saveEditComment() {
                let content = $("#editCommentContent").val()
                $.ajax({
                    url: '/post/edit-comment',
                    data: {commId: editCommentId, content},
                    method: 'post',
                    success: function (res) {
                        window.location.reload()
                    }
                })
            }

            // 评论框按键监听事件
            function tab(obj) {
                if (event.keyCode == 9) {
                    event.preventDefault();
                    var indent = '    ';
                    var start = obj.selectionStart;
                    var end = obj.selectionEnd;
                    var selected = window.getSelection().toString();
                    selected = indent + selected.replace(/\n/g, '\n' + indent);
                    obj.value = obj.value.substring(0, start) + selected
                        + obj.value.substring(end);
                    obj.setSelectionRange(start + indent.length, start
                        + selected.length);
                }
            }

            function isEmpty() {
                let comment = $("#commentContent").val();
                // 防止一直按回车键输入空白的评论内容
                if (comment.replace(/<br>/g, '').replace(/\s*/g, '') == '') {
                    $(".p-error-hint").slideDown(500);
                    $(".p-error-hint").show().delay(2000).hide(500);
                    return false;
                }
                if (!comment) {
                    $(".p-error-hint").slideDown(500);
                    $(".p-error-hint").show().delay(2000).hide(500);
                    return false;
                }
                return comment;
            }

            // 提交评论
            function postComment() {
                let comment = isEmpty();
                if (!comment) {
                    return false;
                }
                let postId = $("#postTitle").data("id");
                let comBtn = $("#commentBtn")
                comBtn.attr('disabled', 'disabled')
                comBtn.html('评论<i class="fa fa-pulse fa-spinner"></i>')
                $.ajax({
                    type: "post",
                    data: {"commentContent": comment, 'postId': postId},
                    url: "/post/post-comment/",
                    success: function (res) {
                        if (res.tag === 1) {
                            window.location.reload();
                        } else {
                            comBtn.attr('disabled', 'false')
                            comBtn.html('评论')
                        }
                    },
                    error: function () {
                        comBtn.removeAttr('disabled')
                        comBtn.html('评论')
                        alert('服务器发生错误，评论失败！')
                    }
                })
            }

            function submitDelete(commId) {
                $.ajax({
                    url: '/post/delete-comment/',
                    type: 'POST',
                    data: {'comm_id': commId},
                    success: function (res) {
                        if (res.tag) {
                            window.location.reload();
                        } else {
                            alert("删除评论失败!");
                            return false;
                        }
                    },
                    error: function () {
                    }
                })
            }

            $("#confirm-delete").on("show.bs.modal", function (e) {
                let commID = $(e.relatedTarget).data('commid');
                $("#deleteBtn").val(commID);
            })

            $("#edit-comment").on('show.bs.modal', function (e) {
                let commId = $(e.relatedTarget).data('commid')

                if (commId != editCommentId) {
                    editCommentId = commId
                    $.ajax({
                        url: '/post/get-comment',
                        data: {'commId': editCommentId},
                        method: 'post',
                        success: function (res) {
                            $("#editCommentContent").text(res.markdown)
                        }
                    })
                }
            })

            function upload() {
                $("#uploadInput").click();
            }

            function uploadImage() {
                let img = $("#uploadInput")[0].files[0];
                let formdata = new FormData();
                formdata.append('file', img);
                uploadimg2server(formdata)
            }

            // 在textarea中插入上传的图片markdown的值
            function insertText(obj, str) {
                if (document.selection) {
                    var sel = document.selection.createRange();
                    sel.text = str;
                } else if (typeof obj.selectionStart === 'number' && typeof obj.selectionEnd === 'number') {
                    var startPos = obj.selectionStart,
                        endPos = obj.selectionEnd,
                        cursorPos = startPos,
                        tmpStr = obj.value;
                    obj.value = tmpStr.substring(0, startPos) + str + tmpStr.substring(endPos, tmpStr.length);
                    cursorPos += str.length;
                    obj.selectionStart = obj.selectionEnd = cursorPos;
                } else {
                    obj.value += str;
                }
                obj.focus()
            }
        </script>
    </main>
    </body>
{% endblock %}
